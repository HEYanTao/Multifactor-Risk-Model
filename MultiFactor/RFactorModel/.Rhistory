weekdate<-weekgain[,1]
plotdate<-beta[,1]
#Gain#
gainf_m<-function(y,stocklist){
data<-w.wsd(stocklist,"pct_chg",startdatefunwithhash(y),Sys.Date()
,"Period=M;Fill=Previous;PriceAdj=F")$Data
data[,-1]<-data[,-1]/100
data<-removeNA(data)
data
}
#Beta#
betafun_m<-function(y,stocklist){
data<-w.wsd(stocklist,"beta_100w",startdatefunwithhash(y),Sys.Date()
,"Period=M;Fill=Previous;PriceAdj=F")$Data
#       print(paste0("beta missing value:",sum(is.na(data)),"/",nrow(data)*ncol(data)))
data<-standard_m(data)
data<-removeNA(data)
data
}
#Momentum#
momentumfun_m<-function(y,stocklist){
data<-w.wsd(stocklist,"annualyeild_100w",startdatefunwithhash(y),Sys.Date()
,"Period=M;Fill=Previous;PriceAdj=F")$Data
#       print(paste0("momentum missing value:",sum(is.na(data)),"/",nrow(data)*ncol(data)))
data[,-1]<-data[,-1]/100
data<-standard_m(data)
data<-removeNA(data)
data
}
#Size#
sizefun_m<-function(y,stocklist){
data<-w.wsd(stocklist,"total_shares",startdatefunwithhash(y),Sys.Date(),
"Period=M;Fill=Previous;PriceAdj=F")$Data
#       print(paste0("size missing value:",sum(is.na(data)),"/",nrow(data)*ncol(data)))
data<-removeNA(data)
data[,-1]<-log10(data[,-1])
data<-standard_m(data)
data<-removeNA(data)
data
}
#Earnings Yield#
eroefun_m<-function(y,stocklist){
data<-w.wsd(stocklist,"west_avgroe_FY1",startdatefunwithhash(y),Sys.Date(),
"Period=M;Fill=Previous;PriceAdj=F")$Data
#       print(paste0("eroe missing value:",sum(is.na(data)),"/",nrow(data)*ncol(data)))
data<-standard_m(data)
data<-removeNA(data)
data
}
eepsfun_m<-function(y,stocklist){
data<-w.wsd(stocklist,"west_eps_FY1",startdatefunwithhash(y),Sys.Date(),
"Period=M;Fill=Previous;PriceAdj=F")$Data
#       print(paste0("eeps missing value:",sum(is.na(data)),"/",nrow(data)*ncol(data)))
data<-standard_m(data)
data<-removeNA(data)
data
}
pefun_m<-function(y,stocklist){
data<-w.wsd(stocklist,"rating_avg",startdatefunwithhash(y),Sys.Date(),
"Period=M;Fill=Previous;PriceAdj=F")$Data
#        print(paste0("pe missing value:",sum(is.na(data)),"/",nrow(data)*ncol(data)))
data<-standard_m(data)
data<-removeNA(data)
data
}
gain_m<-gainf_m(y,stocklist)
beta_m<-betafun_m(y,stocklist)
momentum_m<-momentumfun_m(y,stocklist)
size_m<-sizefun_m(y,stocklist)
eroe_m<-eroefun_m(y,stocklist)
eeps_m<-eepsfun_m(y,stocklist)
eroe_m<-eroefun_m(y,stocklist)
mdate<-size_m[,1]
eroe[eroe[,1]=mdate,]
eroe[eroe[,1]==mdate,]
eroe[eroe[,1]%in%mdate,]
eroe_m<-eroe[eroe[,1]%in%mdate,]
View(eroe_m)
View(gain_m)
eroe_m[1,1]
eeps_m<-eeps[eeps[,1]%in%mdate,]
pe<-pefun(y,stocklist)
save.image("C:/Users/shixi19/Desktop/9-23.RData")
pe<-eeps
{#Optimization#
{
calgain<-function(variables,eroe,eeps,pe){
gain=eroe
gain[,-1]=variables[1]*(eroe[,-1])+variables[2]*(eeps[,-1])+variables[3]*(pe[,-1])
gain<-removeNA(gain)
gain
}
difference<-function(variables,eroe,eeps,pe,real){
diff<-sum(((real[,-1])-calgain(variables,eroe,eeps,pe)[,-1])^2)
diff<-removeNA(diff)
diff
}
variables<-c(1,1,1)
optimresult<-optim(variables,difference,eroe=eroe[-nrow(eroe),],
eeps=eeps[-nrow(eeps),],pe=pe[-nrow(pe),],real=gain[-1,])
subweight<-optimresult$par
}
#Generate Earnings Yield#
earningsyield<-calgain(subweight,eroe,eeps,pe)
earningsyield<-standard(earningsyield)
expectation<-earningsyield
}
pe_m<-pefun_m(y,stocklist)
pe_m<-pe[pe[,1]%in%mdate,]
{
calgain<-function(variables,eroe,eeps,pe){
gain=eroe
gain[,-1]=variables[1]*(eroe[,-1])+variables[2]*(eeps[,-1])+variables[3]*(pe[,-1])
gain<-removeNA(gain)
gain
}
difference<-function(variables,eroe,eeps,pe,real){
diff<-sum(((real[,-1])-calgain(variables,eroe,eeps,pe)[,-1])^2)
diff<-removeNA(diff)
diff
}
variables<-c(1,1,1)
optimresult<-optim(variables,difference,eroe=eroe_m[-nrow(eroe_m),],
eeps=eeps_m[-nrow(eeps_m),],pe=pe_m[-nrow(pe_m),],real=gain_m[-1,])
subweight<-optimresult$par
}
{
calgain<-function(variables,eroe,eeps,pe){
gain=eroe
gain[,-1]=variables[1]*(eroe[,-1])+variables[2]*(eeps[,-1])+variables[3]*(pe[,-1])
gain<-removeNA(gain)
gain
}
difference<-function(variables,eroe,eeps,pe,real){
diff<-sum(((real[,-1])-calgain(variables,eroe,eeps,pe)[,-1])^2)
diff<-removeNA(diff)
diff
}
variables<-c(1,1,1)
optimresult<-optim(variables,difference,eroe=eroe_m[-nrow(eroe_m),],
eeps=eeps_m[-nrow(eeps_m),],pe=pe_m[-nrow(pe_m),],real=gain_m[-1,])
subweight<-optimresult$par
}
#Generate Earnings Yield#
earningsyield<-calgain(subweight,eroe_m,eeps_m,pe_m)
earningsyield_m<-standard_m(earningsyield)
sizeweight_l<-sizeweight(stocklist)
getdatareadyforcov<-function(d1,d2){
i1<-grep(d1,plotdate)
i2<-grep(d2,plotdate)
tempbeta<-betagain[i1:i2]
tempmom<-momentumgain[i1:i2]
tempsize<-sizegain[i1:i2]
tempexp<-expectationgain[i1:i2]
covdata<-data.frame(beta=tempbeta,momentum=tempmom,size=tempsize,expectation=tempexp)
return(covdata)
}
getrisk<-function(d1,d2,w){
covf<-cov(getdatareadyforcov(d1,d2))
covf<-rbind(as.numeric(covf[1,]),as.numeric(covf[2,]),as.numeric(covf[3,]),as.numeric(covf[4,]))
x<-rbind(as.numeric(beta[1,-1]),as.numeric(momentum[1,-1]),as.numeric(size[1,-1]),as.numeric(expectation[1,-1]))
risk<-t(w)%*%t(x)%*%covf%*%x%*%w
return(sqrt(risk))
}#Get the risk of porto in d2, d1 is the day start to
temp<-rbind(sizeweight_l,stock_industry)
indusweight<-temp
w<-rep(1/797,797)
i<-3
gainfun<-function(w){
-(as.numeric(0.2*w%*%as.numeric(gain_m[i-2,-1])+0.3*w%*%as.numeric(gain_m[i-1,-1])+0.5*w%*%as.numeric(gain_m[i,-1]))-(0.5*zcf1_CLOSE_p_m[i]/100+0.3*zcf1_CLOSE_p_m[i-1]/100+0.2*zcf1_CLOSE_p_m[i-2]/100))+0.75*getrisk(monthdate[i-1],monthdate[i],w)#Lambda=0.75
}
equalcon<-function(w){
sum(w)
}
inequalcon<-function(w){
a<-0.5*((as.numeric((w-sizeweight_l)%*%as.numeric(beta_m[i,-1])))/(sizeweight_l%*%(as.numeric(beta_m[i,-1])^2)))+0.3*((as.numeric((w-sizeweight_l)%*%as.numeric(beta_m[i-1,-1])))/(sizeweight_l%*%(as.numeric(beta_m[i-1,-1])^2)))+0.2*((as.numeric((w-sizeweight_l)%*%as.numeric(beta_m[i-2,-1])))/(sizeweight_l%*%(as.numeric(beta_m[i-2,-1])^2)))
b<-0.5*((as.numeric((w-sizeweight_l)%*%as.numeric(momentum_m[i,-1])))/(sizeweight_l%*%(as.numeric(momentum_m[i,-1])^2)))+0.3*((as.numeric((w-sizeweight_l)%*%as.numeric(momentum_m[i-1,-1])))/(sizeweight_l%*%(as.numeric(momentum_m[i-1,-1])^2)))+0.2*((as.numeric((w-sizeweight_l)%*%as.numeric(momentum_m[i-2,-1])))/(sizeweight_l%*%(as.numeric(momentum_m[i-2,-1])^2)))
c<-0.5*((as.numeric((w-sizeweight_l)%*%as.numeric(size_m[i,-1])))/(sizeweight_l%*%(as.numeric(size_m[i,-1])^2)))+0.3*((as.numeric((w-sizeweight_l)%*%as.numeric(size_m[i-1,-1])))/(sizeweight_l%*%(as.numeric(size_m[i-1,-1])^2)))+0.2*((as.numeric((w-sizeweight_l)%*%as.numeric(size_m[i-2,-1])))/(sizeweight_l%*%(as.numeric(size_m[i-2,-1])^2)))
d<-0.5*((as.numeric((w-sizeweight_l)%*%as.numeric(earningsyield_m[i,-1])))/(sizeweight_l%*%(as.numeric(earningsyield_m[i,-1])^2)))+0.3*((as.numeric((w-sizeweight_l)%*%as.numeric(earningsyield_m[i-1,-1])))/(sizeweight_l%*%(as.numeric(earningsyield_m[i-1,-1])^2)))+0.2*((as.numeric((w-sizeweight_l)%*%as.numeric(earningsyield_m[i-2,-1])))/(sizeweight_l%*%(as.numeric(earningsyield_m[i-2,-1])^2)))
tt<-rbind(as.numeric(w),indusweight[4,])
treal<-as.numeric(tapply(as.numeric(tt[1,]),as.character(tt[2,]),sum))
industry<-sum(abs(treal-tindex))/2
a<-removeNA(a)
b<-removeNA(b)
c<-removeNA(c)
d<-removeNA(d)
industry<-removeNA(industry)
return(c(a,b,c,d,industry))
}
gainfun(w)
{
t<-regplot(1)
betagain<-t$coefficients[1,1]
momentumgain<-t$coefficients[2,1]
sizegain<-t$coefficients[3,1]
expectationgain<-t$coefficients[4,1]
betat<-t$coefficients[1,3]
momentumt<-t$coefficients[2,3]
sizet<-t$coefficients[3,3]
expectationt<-t$coefficients[4,3]
}
for(i in 2:(nrow(beta)-1)){
t<-regplot(i)
betagain<-c(betagain,t$coefficients[1,1])
momentumgain<-c(momentumgain,t$coefficients[2,1])
sizegain<-c(sizegain,t$coefficients[3,1])
expectationgain<-c(expectationgain,t$coefficients[4,1])
betat<-c(betat,t$coefficients[1,3])
momentumt<-c(momentumt,t$coefficients[2,3])
sizet<-c(sizet,t$coefficients[3,3])
expectationt<-c(expectationt,t$coefficients[4,3])
}
cordata<-data.frame(beta=betagain,momentum=momentumgain,size=sizegain,exp=expectationgain)
regplot<-function(i){
regdatafun<-function(i){
regdata<-data.frame(extragain=as.numeric(gain[i+1,-1])-(as.numeric(zcf1_CLOSE_p[i+1])/100),
beta=as.numeric(beta[i,-1]),
momentum=as.numeric(momentum[i,-1]),
size=as.numeric(size[i,-1]),
expectation=as.numeric(earningsyield[i,-1])
,indus=factor(as.character(stock_industry[3,])))
return(regdata)
}
regdata<-regdatafun(i)
full.model<-lm(extragain~.,data=regdata)
# best.model<-step(full.model,direction="backward")
# par(mfrow=c(2,2),mar=c(2,4,2,2))
# plot(full.model)
return(summary(full.model))
}
{
t<-regplot(1)
betagain<-t$coefficients[1,1]
momentumgain<-t$coefficients[2,1]
sizegain<-t$coefficients[3,1]
expectationgain<-t$coefficients[4,1]
betat<-t$coefficients[1,3]
momentumt<-t$coefficients[2,3]
sizet<-t$coefficients[3,3]
expectationt<-t$coefficients[4,3]
}
for(i in 2:(nrow(beta)-1)){
t<-regplot(i)
betagain<-c(betagain,t$coefficients[1,1])
momentumgain<-c(momentumgain,t$coefficients[2,1])
sizegain<-c(sizegain,t$coefficients[3,1])
expectationgain<-c(expectationgain,t$coefficients[4,1])
betat<-c(betat,t$coefficients[1,3])
momentumt<-c(momentumt,t$coefficients[2,3])
sizet<-c(sizet,t$coefficients[3,3])
expectationt<-c(expectationt,t$coefficients[4,3])
}
cordata<-data.frame(beta=betagain,momentum=momentumgain,size=sizegain,exp=expectationgain)
{
t<-regplot(1)
betagain<-t$coefficients[1,1]
momentumgain<-t$coefficients[2,1]
sizegain<-t$coefficients[3,1]
expectationgain<-t$coefficients[4,1]
betat<-t$coefficients[1,3]
momentumt<-t$coefficients[2,3]
sizet<-t$coefficients[3,3]
expectationt<-t$coefficients[4,3]
}
for(i in 2:(nrow(beta)-1)){
t<-regplot(i)
betagain<-c(betagain,t$coefficients[1,1])
momentumgain<-c(momentumgain,t$coefficients[2,1])
sizegain<-c(sizegain,t$coefficients[3,1])
expectationgain<-c(expectationgain,t$coefficients[4,1])
betat<-c(betat,t$coefficients[1,3])
momentumt<-c(momentumt,t$coefficients[2,3])
sizet<-c(sizet,t$coefficients[3,3])
expectationt<-c(expectationt,t$coefficients[4,3])
}
regplot(i)
regdatafun(i)
regdatafun<-function(i){
regdata<-data.frame(extragain=as.numeric(gain[i+1,-1])-(as.numeric(zcf1_CLOSE_p[i+1])/100),
beta=as.numeric(beta[i,-1]),
momentum=as.numeric(momentum[i,-1]),
size=as.numeric(size[i,-1]),
expectation=as.numeric(earningsyield[i,-1])
,indus=factor(as.character(stock_industry[3,])))
return(regdata)
}
regdatafun(i)
{
calgain<-function(variables,eroe,eeps,pe){
gain=eroe
gain[,-1]=variables[1]*(eroe[,-1])+variables[2]*(eeps[,-1])+variables[3]*(pe[,-1])
gain<-removeNA(gain)
gain
}
difference<-function(variables,eroe,eeps,pe,real){
diff<-sum(((real[,-1])-calgain(variables,eroe,eeps,pe)[,-1])^2)
diff<-removeNA(diff)
diff
}
variables<-c(1,1,1)
optimresult<-optim(variables,difference,eroe=eroe[-nrow(eroe),],
eeps=eeps[-nrow(eeps),],pe=pe[-nrow(pe),],real=gain[-1,])
subweight<-optimresult$par
}
expectation_m<-earningsyield_m
{
t<-regplot(1)
betagain<-t$coefficients[1,1]
momentumgain<-t$coefficients[2,1]
sizegain<-t$coefficients[3,1]
expectationgain<-t$coefficients[4,1]
betat<-t$coefficients[1,3]
momentumt<-t$coefficients[2,3]
sizet<-t$coefficients[3,3]
expectationt<-t$coefficients[4,3]
}
for(i in 2:(nrow(beta)-1)){
t<-regplot(i)
betagain<-c(betagain,t$coefficients[1,1])
momentumgain<-c(momentumgain,t$coefficients[2,1])
sizegain<-c(sizegain,t$coefficients[3,1])
expectationgain<-c(expectationgain,t$coefficients[4,1])
betat<-c(betat,t$coefficients[1,3])
momentumt<-c(momentumt,t$coefficients[2,3])
sizet<-c(sizet,t$coefficients[3,3])
expectationt<-c(expectationt,t$coefficients[4,3])
}
cordata<-data.frame(beta=betagain,momentum=momentumgain,size=sizegain,exp=expectationgain)
View(expectation_m)
regdata<-data.frame(extragain=as.numeric(gain[i+1,-1])-(as.numeric(zcf1_CLOSE_p[i+1])/100),
beta=as.numeric(beta[i,-1]),
momentum=as.numeric(momentum[i,-1]),
size=as.numeric(size[i,-1]),
expectation=as.numeric(earningsyield[i,-1])
,indus=factor(as.character(stock_industry[3,])))
regdata(i)
regdatafun(i)
View(expectation)
as.numeric(earningsyield[i,-1])
earningsyield[i,-1]
i
regplot<-function(i){
regdatafun<-function(i){
regdata<-data.frame(extragain=as.numeric(gain[i+1,-1])-(as.numeric(zcf1_CLOSE_p[i+1])/100),
beta=as.numeric(beta[i,-1]),
momentum=as.numeric(momentum[i,-1]),
size=as.numeric(size[i,-1]),
expectation=as.numeric(earningsyield[i,-1])
,indus=factor(as.character(stock_industry[3,])))
return(regdata)
}
regdata<-regdatafun(i)
full.model<-lm(extragain~.,data=regdata)
# best.model<-step(full.model,direction="backward")
# par(mfrow=c(2,2),mar=c(2,4,2,2))
# plot(full.model)
return(summary(full.model))
}
regplot(3)
regplot(30)
regplot(39)
regdatafun(40)
regdatafun(4)
regdatafun(40)
regplot<-function(i){
regdatafun<-function(i){
regdata<-data.frame(extragain=as.numeric(gain[i+1,-1])-(as.numeric(zcf1_CLOSE_p[i+1])/100),
beta=as.numeric(beta[i,-1]),
momentum=as.numeric(momentum[i,-1]),
size=as.numeric(size[i,-1]),
expectation=as.numeric(expectation[i,-1])
,indus=factor(as.character(stock_industry[3,])))
return(regdata)
}
regdata<-regdatafun(i)
full.model<-lm(extragain~.,data=regdata)
# best.model<-step(full.model,direction="backward")
# par(mfrow=c(2,2),mar=c(2,4,2,2))
# plot(full.model)
return(summary(full.model))
}
regplot(100)
for(i in 2:(nrow(beta)-1)){
t<-regplot(i)
betagain<-c(betagain,t$coefficients[1,1])
momentumgain<-c(momentumgain,t$coefficients[2,1])
sizegain<-c(sizegain,t$coefficients[3,1])
expectationgain<-c(expectationgain,t$coefficients[4,1])
betat<-c(betat,t$coefficients[1,3])
momentumt<-c(momentumt,t$coefficients[2,3])
sizet<-c(sizet,t$coefficients[3,3])
expectationt<-c(expectationt,t$coefficients[4,3])
}
cordata<-data.frame(beta=betagain,momentum=momentumgain,size=sizegain,exp=expectationgain)
getdatareadyforcov<-function(d1,d2){
i1<-grep(d1,plotdate)
i2<-grep(d2,plotdate)
tempbeta<-betagain[i1:i2]
tempmom<-momentumgain[i1:i2]
tempsize<-sizegain[i1:i2]
tempexp<-expectationgain[i1:i2]
covdata<-data.frame(beta=tempbeta,momentum=tempmom,size=tempsize,expectation=tempexp)
return(covdata)
}
getrisk<-function(d1,d2,w){
covf<-cov(getdatareadyforcov(d1,d2))
covf<-rbind(as.numeric(covf[1,]),as.numeric(covf[2,]),as.numeric(covf[3,]),as.numeric(covf[4,]))
x<-rbind(as.numeric(beta[1,-1]),as.numeric(momentum[1,-1]),as.numeric(size[1,-1]),as.numeric(expectation[1,-1]))
risk<-t(w)%*%t(x)%*%covf%*%x%*%w
return(sqrt(risk))
}#Get the risk of porto in d2, d1 is the day start to
getrisk(monthdate[1],monthdate[2],w)
gainfun<-function(w){
-(as.numeric(0.2*w%*%as.numeric(gain_m[i-2,-1])+0.3*w%*%as.numeric(gain_m[i-1,-1])+0.5*w%*%as.numeric(gain_m[i,-1]))-(0.5*zcf1_CLOSE_p_m[i]/100+0.3*zcf1_CLOSE_p_m[i-1]/100+0.2*zcf1_CLOSE_p_m[i-2]/100))+0.75*getrisk(monthdate[i-1],monthdate[i],w)#Lambda=0.75
}
equalcon<-function(w){
sum(w)
}
inequalcon<-function(w){
a<-0.5*((as.numeric((w-sizeweight_l)%*%as.numeric(beta_m[i,-1])))/(sizeweight_l%*%(as.numeric(beta_m[i,-1])^2)))+0.3*((as.numeric((w-sizeweight_l)%*%as.numeric(beta_m[i-1,-1])))/(sizeweight_l%*%(as.numeric(beta_m[i-1,-1])^2)))+0.2*((as.numeric((w-sizeweight_l)%*%as.numeric(beta_m[i-2,-1])))/(sizeweight_l%*%(as.numeric(beta_m[i-2,-1])^2)))
b<-0.5*((as.numeric((w-sizeweight_l)%*%as.numeric(momentum_m[i,-1])))/(sizeweight_l%*%(as.numeric(momentum_m[i,-1])^2)))+0.3*((as.numeric((w-sizeweight_l)%*%as.numeric(momentum_m[i-1,-1])))/(sizeweight_l%*%(as.numeric(momentum_m[i-1,-1])^2)))+0.2*((as.numeric((w-sizeweight_l)%*%as.numeric(momentum_m[i-2,-1])))/(sizeweight_l%*%(as.numeric(momentum_m[i-2,-1])^2)))
c<-0.5*((as.numeric((w-sizeweight_l)%*%as.numeric(size_m[i,-1])))/(sizeweight_l%*%(as.numeric(size_m[i,-1])^2)))+0.3*((as.numeric((w-sizeweight_l)%*%as.numeric(size_m[i-1,-1])))/(sizeweight_l%*%(as.numeric(size_m[i-1,-1])^2)))+0.2*((as.numeric((w-sizeweight_l)%*%as.numeric(size_m[i-2,-1])))/(sizeweight_l%*%(as.numeric(size_m[i-2,-1])^2)))
d<-0.5*((as.numeric((w-sizeweight_l)%*%as.numeric(earningsyield_m[i,-1])))/(sizeweight_l%*%(as.numeric(earningsyield_m[i,-1])^2)))+0.3*((as.numeric((w-sizeweight_l)%*%as.numeric(earningsyield_m[i-1,-1])))/(sizeweight_l%*%(as.numeric(earningsyield_m[i-1,-1])^2)))+0.2*((as.numeric((w-sizeweight_l)%*%as.numeric(earningsyield_m[i-2,-1])))/(sizeweight_l%*%(as.numeric(earningsyield_m[i-2,-1])^2)))
tt<-rbind(as.numeric(w),indusweight[4,])
treal<-as.numeric(tapply(as.numeric(tt[1,]),as.character(tt[2,]),sum))
industry<-sum(abs(treal-tindex))/2
a<-removeNA(a)
b<-removeNA(b)
c<-removeNA(c)
d<-removeNA(d)
industry<-removeNA(industry)
return(c(a,b,c,d,industry))
}
gainfun(w)
i<-3
gainfun(w)
equalcon(w)
inequalcon(w)
tindex<-as.numeric(tapply(as.numeric(indusweight[1,]),as.character(indusweight[4,]),sum))
inequalcon(w)
inequalcon(sizeweight_l)
summary(expectation[1,-1])
summary(as.numericexpectation[1,-1]))
summary(as.numeric(expectation[1,-1]))
summary(as.numeric(expectation[2,-1]))
summary(as.numeric(expectation_m[2,-1]))
summary(as.numeric(expectation_m[1,-1]))
summary(as.numeric(expectation_m[3,-1]))
summary(as.numeric(size_m[3,-1]))
summary(as.numeric(size[3,-1]))
summary(as.numeric(expectation_m[3,-1]))
summary(as.numeric(expectation[3,-1]))
inequalcon<-function(w){
a<-0.5*((as.numeric((w-sizeweight_l)%*%as.numeric(beta_m[i,-1])))/(sqrt(sizeweight_l%*%(as.numeric(beta_m[i,-1])^2))))+0.3*((as.numeric((w-sizeweight_l)%*%as.numeric(beta_m[i-1,-1])))/(sqrt(sizeweight_l%*%(as.numeric(beta_m[i-1,-1])^2))))+0.2*((as.numeric((w-sizeweight_l)%*%as.numeric(beta_m[i-2,-1])))/(sqrt(sizeweight_l%*%(as.numeric(beta_m[i-2,-1])^2))))
b<-0.5*((as.numeric((w-sizeweight_l)%*%as.numeric(momentum_m[i,-1])))/(sqrt(sizeweight_l%*%(as.numeric(momentum_m[i,-1])^2))))+0.3*((as.numeric((w-sizeweight_l)%*%as.numeric(momentum_m[i-1,-1])))/(sqrt(sizeweight_l%*%(as.numeric(momentum_m[i-1,-1])^2))))+0.2*((as.numeric((w-sizeweight_l)%*%as.numeric(momentum_m[i-2,-1])))/(sqrt(sizeweight_l%*%(as.numeric(momentum_m[i-2,-1])^2))))
c<-0.5*((as.numeric((w-sizeweight_l)%*%as.numeric(size_m[i,-1])))/(sqrt(sizeweight_l%*%(as.numeric(size_m[i,-1])^2))))+0.3*((as.numeric((w-sizeweight_l)%*%as.numeric(size_m[i-1,-1])))/(sqrt(sizeweight_l%*%(as.numeric(size_m[i-1,-1])^2))))+0.2*((as.numeric((w-sizeweight_l)%*%as.numeric(size_m[i-2,-1])))/(sqrt(sizeweight_l%*%(as.numeric(size_m[i-2,-1])^2))))
d<-0.5*((as.numeric((w-sizeweight_l)%*%as.numeric(earningsyield_m[i,-1])))/(sqrt(sizeweight_l%*%(as.numeric(earningsyield_m[i,-1])^2))))+0.3*((as.numeric((w-sizeweight_l)%*%as.numeric(earningsyield_m[i-1,-1])))/(sqrt(sizeweight_l%*%(as.numeric(earningsyield_m[i-1,-1])^2))))+0.2*((as.numeric((w-sizeweight_l)%*%as.numeric(earningsyield_m[i-2,-1])))/(sqrt(sizeweight_l%*%(as.numeric(earningsyield_m[i-2,-1])^2))))
tt<-rbind(as.numeric(w),indusweight[4,])
treal<-as.numeric(tapply(as.numeric(tt[1,]),as.character(tt[2,]),sum))
industry<-sum(abs(treal-tindex))/2
a<-removeNA(a)
b<-removeNA(b)
c<-removeNA(c)
d<-removeNA(d)
industry<-removeNA(industry)
return(c(a,b,c,d,industry))
}
inequalcon(w)
w.close()
temp<-rbind(sizeweight_l,stock_industry)
indusweight<-temp
library(parallel)
library(foreach)
library(doParallel)
library(truncnorm)
library(Rsolnp)
tindex<-as.numeric(tapply(as.numeric(indusweight[1,]),as.character(indusweight[4,]),sum))
getporto_final<-function(i){
library(truncnorm)
library(Rsolnp)
gainfun<-function(w){
-(as.numeric(0.2*w%*%as.numeric(gain_m[i-2,-1])+0.3*w%*%as.numeric(gain_m[i-1,-1])+0.5*w%*%as.numeric(gain_m[i,-1]))-(0.5*zcf1_CLOSE_p_m[i]/100+0.3*zcf1_CLOSE_p_m[i-1]/100+0.2*zcf1_CLOSE_p_m[i-2]/100))+0.75*getrisk(monthdate[i-1],monthdate[i],w)#Lambda=0.75
}
equalcon<-function(w){
sum(w)
}
inequalcon<-function(w){
a<-0.5*((as.numeric((w-sizeweight_l)%*%as.numeric(beta_m[i,-1])))/(sqrt(sizeweight_l%*%(as.numeric(beta_m[i,-1])^2))))+0.3*((as.numeric((w-sizeweight_l)%*%as.numeric(beta_m[i-1,-1])))/(sqrt(sizeweight_l%*%(as.numeric(beta_m[i-1,-1])^2))))+0.2*((as.numeric((w-sizeweight_l)%*%as.numeric(beta_m[i-2,-1])))/(sqrt(sizeweight_l%*%(as.numeric(beta_m[i-2,-1])^2))))
b<-0.5*((as.numeric((w-sizeweight_l)%*%as.numeric(momentum_m[i,-1])))/(sqrt(sizeweight_l%*%(as.numeric(momentum_m[i,-1])^2))))+0.3*((as.numeric((w-sizeweight_l)%*%as.numeric(momentum_m[i-1,-1])))/(sqrt(sizeweight_l%*%(as.numeric(momentum_m[i-1,-1])^2))))+0.2*((as.numeric((w-sizeweight_l)%*%as.numeric(momentum_m[i-2,-1])))/(sqrt(sizeweight_l%*%(as.numeric(momentum_m[i-2,-1])^2))))
c<-0.5*((as.numeric((w-sizeweight_l)%*%as.numeric(size_m[i,-1])))/(sqrt(sizeweight_l%*%(as.numeric(size_m[i,-1])^2))))+0.3*((as.numeric((w-sizeweight_l)%*%as.numeric(size_m[i-1,-1])))/(sqrt(sizeweight_l%*%(as.numeric(size_m[i-1,-1])^2))))+0.2*((as.numeric((w-sizeweight_l)%*%as.numeric(size_m[i-2,-1])))/(sqrt(sizeweight_l%*%(as.numeric(size_m[i-2,-1])^2))))
d<-0.5*((as.numeric((w-sizeweight_l)%*%as.numeric(earningsyield_m[i,-1])))/(sqrt(sizeweight_l%*%(as.numeric(earningsyield_m[i,-1])^2))))+0.3*((as.numeric((w-sizeweight_l)%*%as.numeric(earningsyield_m[i-1,-1])))/(sqrt(sizeweight_l%*%(as.numeric(earningsyield_m[i-1,-1])^2))))+0.2*((as.numeric((w-sizeweight_l)%*%as.numeric(earningsyield_m[i-2,-1])))/(sqrt(sizeweight_l%*%(as.numeric(earningsyield_m[i-2,-1])^2))))
tt<-rbind(as.numeric(w),indusweight[4,])
treal<-as.numeric(tapply(as.numeric(tt[1,]),as.character(tt[2,]),sum))
industry<-sum(abs(treal-tindex))/2
a<-removeNA(a)
b<-removeNA(b)
c<-removeNA(c)
d<-removeNA(d)
industry<-removeNA(industry)
return(c(a,b,c,d,industry))
}
portofolio<-solnp(pars=sizeweight_l,fun=gainfun
,eqfun=equalcon,eqB=1,ineqfun=inequalcon
,ineqLB=(c(-0.1,-0.1,-0.1,-1,-0.2))
,ineqUB=(c(0.1,0.1,0.1,1,0.2)),
LB=rep(0,num.stock),UB=rep(0.2,num.stock))##Means we cannot put more than 20 percent weight on one single stock
return(portofolio$par)
}
cl <- makeCluster(4)
registerDoParallel(cl)
testmulti_final<- foreach(x=3:32,.combine='rbind') %dopar% getporto_final(x)
stopCluster(cl)
